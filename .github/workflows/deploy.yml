name: Deploy to AI Builders

on:
  push:
    branches:
      - main
  workflow_dispatch: # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  deploy:
    runs-on: ubuntu-latest
    name: Deploy to AI Builders Space
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy to AI Builders
        env:
          AI_BUILDER_TOKEN: ${{ secrets.AI_BUILDER_TOKEN }}
        run: |
          set -e  # é‡åˆ°é”™è¯¯ç«‹å³é€€å‡º
          
          echo "ğŸš€ å¼€å§‹éƒ¨ç½²åˆ° AI Builders..."
          echo "ğŸ“… æ—¶é—´: $(date)"
          
          # æ£€æŸ¥ AI_BUILDER_TOKEN æ˜¯å¦å·²è®¾ç½®
          if [ -z "$AI_BUILDER_TOKEN" ]; then
            echo "âŒ é”™è¯¯: AI_BUILDER_TOKEN secret æœªè®¾ç½®ï¼"
            echo "ğŸ“ è¯·è®¿é—®ä»¥ä¸‹é“¾æ¥è®¾ç½® Secret:"
            echo "   https://github.com/${{ github.repository }}/settings/secrets/actions"
            exit 1
          fi
          
          echo "âœ… AI_BUILDER_TOKEN å·²é…ç½® (é•¿åº¦: ${#AI_BUILDER_TOKEN} å­—ç¬¦)"
          
          # å‡†å¤‡éƒ¨ç½²æ•°æ®
          REPO_URL="https://github.com/${{ github.repository }}.git"
          echo "ğŸ“¦ ä»“åº“ URL: ${REPO_URL}"
          
          # ä½¿ç”¨ printf æ„å»º JSONï¼ˆæ›´å¯é ï¼‰
          JSON_PAYLOAD=$(printf '{"repo_url":"%s","service_name":"ember-chat","branch":"main","port":3000}' "${REPO_URL}")
          
          echo "ğŸ“¤ å‘é€éƒ¨ç½²è¯·æ±‚..."
          echo "è¯·æ±‚æ•°æ®: ${JSON_PAYLOAD}"
          
          # å‘é€è¯·æ±‚å¹¶ä¿å­˜å“åº”
          response=$(curl -s -w "\nHTTP_CODE:%{http_code}" -X POST "https://space.ai-builders.com/backend/v1/deployments" \
            -H "Authorization: Bearer ${AI_BUILDER_TOKEN}" \
            -H "Content-Type: application/json" \
            -d "${JSON_PAYLOAD}")
          
          # åˆ†ç¦»å“åº”ä½“å’Œ HTTP çŠ¶æ€ç 
          http_code=$(echo "$response" | grep "HTTP_CODE:" | cut -d: -f2)
          response_body=$(echo "$response" | sed '/HTTP_CODE:/d')
          
          echo "ğŸ“¥ HTTP çŠ¶æ€ç : ${http_code}"
          echo "ğŸ“¥ å“åº”å†…å®¹: ${response_body}"
          
          # æ£€æŸ¥ HTTP çŠ¶æ€ç 
          if [ "$http_code" != "200" ]; then
            echo "âŒ HTTP è¯·æ±‚å¤±è´¥ï¼ŒçŠ¶æ€ç : ${http_code}"
            echo "å“åº”: ${response_body}"
            exit 1
          fi
          
          # æ£€æŸ¥å“åº”æ˜¯å¦åŒ…å«é”™è¯¯
          if echo "$response_body" | grep -qi '"error"'; then
            echo "âŒ API è¿”å›é”™è¯¯: ${response_body}"
            exit 1
          fi
          
          # æå–çŠ¶æ€å’Œ URLï¼ˆä½¿ç”¨æ›´å®½æ¾çš„åŒ¹é…ï¼‰
          status=$(echo "$response_body" | grep -oE '"status"\s*:\s*"[^"]*"' | head -1 | grep -oE '"[^"]*"' | head -1 | tr -d '"' || echo "")
          url=$(echo "$response_body" | grep -oE '"public_url"\s*:\s*"[^"]*"' | head -1 | grep -oE '"[^"]*"' | head -1 | tr -d '"' || echo "")
          
          echo "ğŸ“Š è§£æç»“æœ:"
          echo "  çŠ¶æ€: ${status:-æœªæ‰¾åˆ°}"
          echo "  URL: ${url:-æœªæ‰¾åˆ°}"
          
          # å¦‚æœçŠ¶æ€ä¸ºç©ºï¼Œå°è¯•ä»å“åº”ä¸­æŸ¥æ‰¾ä»»ä½•çŠ¶æ€æŒ‡ç¤º
          if [ -z "$status" ]; then
            echo "âš ï¸  æ— æ³•ä»å“åº”ä¸­æå–çŠ¶æ€ï¼Œæ£€æŸ¥å“åº”å†…å®¹..."
            if echo "$response_body" | grep -qi "queued\|active\|deployment"; then
              status="queued"
              echo "âœ… æ£€æµ‹åˆ°éƒ¨ç½²ç›¸å…³å“åº”ï¼Œå‡è®¾éƒ¨ç½²å·²æäº¤"
            fi
          fi
          
          if [ "$status" = "queued" ] || [ "$status" = "active" ] || [ "$http_code" = "200" ]; then
            echo ""
            echo "âœ… éƒ¨ç½²è¯·æ±‚å·²æˆåŠŸæäº¤ï¼"
            echo "ğŸŒ åº”ç”¨ URL: ${url:-https://ember-chat.ai-builders.space/}"
            echo "â³ è¯·ç­‰å¾… 5-10 åˆ†é’Ÿè®©éƒ¨ç½²å®Œæˆ"
            echo ""
            echo "ğŸ“ ä½ å¯ä»¥åœ¨ä»¥ä¸‹é“¾æ¥æŸ¥çœ‹éƒ¨ç½²çŠ¶æ€:"
            echo "   https://ember-chat.ai-builders.space/"
            # å³ä½¿çŠ¶æ€è§£æå¤±è´¥ï¼Œå¦‚æœ HTTP 200 ä¹Ÿè®¤ä¸ºæˆåŠŸ
            if [ "$http_code" = "200" ]; then
              echo "âœ… HTTP 200 å“åº”ï¼Œéƒ¨ç½²è¯·æ±‚å·²æ¥å—"
            fi
          else
            echo "âŒ éƒ¨ç½²å¤±è´¥ï¼ŒçŠ¶æ€: ${status:-æœªçŸ¥}"
            echo "HTTP çŠ¶æ€ç : ${http_code}"
            echo "å®Œæ•´å“åº”: ${response_body}"
            exit 1
          fi

      - name: Deployment Summary
        if: success()
        run: |
          echo "âœ… éƒ¨ç½²å·¥ä½œæµæ‰§è¡ŒæˆåŠŸ"
          echo "ğŸ“ æŸ¥çœ‹éƒ¨ç½²çŠ¶æ€: https://github.com/${{ github.repository }}/actions"
