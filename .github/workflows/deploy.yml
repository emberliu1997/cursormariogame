name: Deploy to AI Builders

on:
  push:
    branches:
      - main
  workflow_dispatch: # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  deploy:
    runs-on: ubuntu-latest
    name: Deploy to AI Builders Space
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy to AI Builders
        env:
          AI_BUILDER_TOKEN: ${{ secrets.AI_BUILDER_TOKEN }}
        run: |
          echo "ğŸš€ å¼€å§‹éƒ¨ç½²åˆ° AI Builders..."
          
          # æ£€æŸ¥ AI_BUILDER_TOKEN æ˜¯å¦å·²è®¾ç½®
          if [ -z "$AI_BUILDER_TOKEN" ]; then
            echo "âŒ é”™è¯¯: AI_BUILDER_TOKEN secret æœªè®¾ç½®ï¼"
            echo "ğŸ“ è¯·è®¿é—®ä»¥ä¸‹é“¾æ¥è®¾ç½® Secret:"
            echo "   https://github.com/${{ github.repository }}/settings/secrets/actions"
            echo "   Name: AI_BUILDER_TOKEN"
            echo "   Value: sk_564e0ec7_05b965ec7494ea05a998e879a85358c4456f"
            exit 1
          fi
          
          echo "âœ… AI_BUILDER_TOKEN å·²é…ç½®"
          
          response=$(curl -s -X POST "https://space.ai-builders.com/backend/v1/deployments" \
            -H "Authorization: Bearer ${AI_BUILDER_TOKEN}" \
            -H "Content-Type: application/json" \
            -d '{
              "repo_url": "https://github.com/${{ github.repository }}.git",
              "service_name": "ember-chat",
              "branch": "main",
              "port": 3000
            }')
          
          echo "éƒ¨ç½²å“åº”: $response"
          
          # æ£€æŸ¥å“åº”æ˜¯å¦åŒ…å«é”™è¯¯
          if echo "$response" | grep -q '"error"'; then
            echo "âŒ API è¿”å›é”™è¯¯: $response"
            exit 1
          fi
          
          status=$(echo $response | grep -o '"status":"[^"]*"' | cut -d'"' -f4 || echo "")
          url=$(echo $response | grep -o '"public_url":"[^"]*"' | cut -d'"' -f4 || echo "")
          
          if [ "$status" = "queued" ] || [ "$status" = "active" ]; then
            echo "âœ… éƒ¨ç½²è¯·æ±‚å·²æäº¤ï¼"
            echo "ğŸŒ åº”ç”¨ URL: $url"
            echo "â³ è¯·ç­‰å¾… 5-10 åˆ†é’Ÿè®©éƒ¨ç½²å®Œæˆ"
          else
            echo "âŒ éƒ¨ç½²å¤±è´¥: $response"
            exit 1
          fi

      - name: Add deployment badge
        if: success()
        run: |
          echo "âœ… éƒ¨ç½²å·¥ä½œæµå·²æˆåŠŸè§¦å‘"
          echo "ğŸ“ ä½ å¯ä»¥åœ¨ GitHub ä»“åº“çš„ Actions æ ‡ç­¾é¡µæŸ¥çœ‹éƒ¨ç½²çŠ¶æ€"

