name: Deploy to AI Builders

on:
  push:
    branches:
      - main
  workflow_dispatch: # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  deploy:
    runs-on: ubuntu-latest
    name: Deploy to AI Builders Space
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy to AI Builders
        env:
          AI_BUILDER_TOKEN: ${{ secrets.AI_BUILDER_TOKEN }}
        run: |
          echo "ğŸš€ å¼€å§‹éƒ¨ç½²åˆ° AI Builders..."
          
          # æ£€æŸ¥ AI_BUILDER_TOKEN æ˜¯å¦å·²è®¾ç½®
          if [ -z "$AI_BUILDER_TOKEN" ]; then
            echo "âŒ é”™è¯¯: AI_BUILDER_TOKEN secret æœªè®¾ç½®ï¼"
            echo "ğŸ“ è¯·è®¿é—®: https://github.com/${{ github.repository }}/settings/secrets/actions"
            exit 1
          fi
          
          echo "âœ… AI_BUILDER_TOKEN å·²é…ç½®"
          
          # å‡†å¤‡éƒ¨ç½²æ•°æ®
          REPO_URL="https://github.com/${{ github.repository }}.git"
          echo "ğŸ“¦ ä»“åº“: ${REPO_URL}"
          
          # æ„å»º JSON payload
          JSON_PAYLOAD=$(printf '{"repo_url":"%s","service_name":"ember-chat","branch":"main","port":3000}' "${REPO_URL}")
          
          echo "ğŸ“¤ å‘é€éƒ¨ç½²è¯·æ±‚..."
          
          # å‘é€è¯·æ±‚
          response=$(curl -s -w "\nHTTP_CODE:%{http_code}" -X POST "https://space.ai-builders.com/backend/v1/deployments" \
            -H "Authorization: Bearer ${AI_BUILDER_TOKEN}" \
            -H "Content-Type: application/json" \
            -d "${JSON_PAYLOAD}" || echo "CURL_ERROR")
          
          # æ£€æŸ¥ curl æ˜¯å¦æˆåŠŸ
          if echo "$response" | grep -q "CURL_ERROR"; then
            echo "âŒ curl è¯·æ±‚å¤±è´¥"
            exit 1
          fi
          
          # åˆ†ç¦» HTTP çŠ¶æ€ç å’Œå“åº”ä½“
          http_code=$(echo "$response" | grep "HTTP_CODE:" | cut -d: -f2 || echo "")
          response_body=$(echo "$response" | sed '/HTTP_CODE:/d' || echo "")
          
          echo "ğŸ“¥ HTTP çŠ¶æ€ç : ${http_code}"
          echo "ğŸ“¥ å“åº”: ${response_body}"
          
          # æ£€æŸ¥ HTTP çŠ¶æ€ç 
          if [ -z "$http_code" ] || [ "$http_code" != "200" ]; then
            echo "âŒ HTTP è¯·æ±‚å¤±è´¥ï¼ŒçŠ¶æ€ç : ${http_code:-æœªçŸ¥}"
            exit 1
          fi
          
          # æ£€æŸ¥å“åº”æ˜¯å¦åŒ…å«é”™è¯¯
          if echo "$response_body" | grep -qi '"error"'; then
            echo "âŒ API è¿”å›é”™è¯¯"
            echo "$response_body"
            exit 1
          fi
          
          # å°è¯•æå–çŠ¶æ€ï¼ˆä½¿ç”¨å¤šç§æ–¹æ³•ï¼‰
          status=""
          if echo "$response_body" | grep -q '"status"'; then
            status=$(echo "$response_body" | grep -o '"status"[[:space:]]*:[[:space:]]*"[^"]*"' | head -1 | sed 's/.*"status"[[:space:]]*:[[:space:]]*"\([^"]*\)".*/\1/' || echo "")
          fi
          
          # å¦‚æœè¿˜æ˜¯æ— æ³•æå–ï¼Œæ£€æŸ¥å“åº”å†…å®¹
          if [ -z "$status" ]; then
            if echo "$response_body" | grep -qi "queued\|active"; then
              status="queued"
            fi
          fi
          
          echo "ğŸ“Š éƒ¨ç½²çŠ¶æ€: ${status:-å·²æäº¤}"
          
          # æˆåŠŸæ¡ä»¶ï¼šHTTP 200 ä¸”æ²¡æœ‰é”™è¯¯
          if [ "$http_code" = "200" ] && [ -n "$response_body" ]; then
            echo ""
            echo "âœ… éƒ¨ç½²è¯·æ±‚å·²æˆåŠŸæäº¤ï¼"
            echo "ğŸŒ åº”ç”¨ URL: https://ember-chat.ai-builders.space/"
            echo "â³ è¯·ç­‰å¾… 5-10 åˆ†é’Ÿè®©éƒ¨ç½²å®Œæˆ"
            exit 0
          else
            echo "âŒ éƒ¨ç½²å¤±è´¥"
            echo "HTTP: ${http_code}"
            echo "å“åº”: ${response_body}"
            exit 1
          fi

      - name: Deployment Summary
        if: success()
        run: |
          echo "âœ… éƒ¨ç½²å·¥ä½œæµæ‰§è¡ŒæˆåŠŸ"
